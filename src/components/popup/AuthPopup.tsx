// @ts-nocheck
import React, { useState, ChangeEvent, FormEvent } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

import { Button } from '../ui/Button'

import { type User } from '../../types/user'
import styles from './AuthPopup.module.css'

interface FormData {
  email: string
  password: string
  confirmPassword: string
  firstName: string
  lastName: string
  phone: string
  companyName: string
  position: string
}

interface Errors {
  [key: string]: string
}

type UserType = 'candidate' | 'hr'

interface AuthPopupProps {
  isOpen: boolean
  onClose: () => void
  onLogin: (user: User) => void
}

interface LoginFormProps {
  formData: FormData
  errors: Errors
  loading: boolean
  onInputChange: (e: ChangeEvent<HTMLInputElement>) => void
  onSubmit: (e: FormEvent) => void
  onSwitchToRegister: (type: UserType) => void
}

interface RegisterFormProps {
  userType: UserType
  formData: FormData
  errors: Errors
  loading: boolean
  onInputChange: (e: ChangeEvent<HTMLInputElement>) => void
  onSubmit: (e: FormEvent) => void
  onSwitchToLogin: () => void
  onUserTypeChange: (type: UserType) => void
}

// ------------------------- //
// –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
// ------------------------- //

const AuthPopup: React.FC<AuthPopupProps> = ({ isOpen, onClose, onLogin }) => {
  const [activeTab, setActiveTab] = useState<'login' | 'register'>('login')
  const [userType, setUserType] = useState<UserType>('candidate')
  const [formData, setFormData] = useState<FormData>({
    email: '',
    password: '',
    confirmPassword: '',
    firstName: '',
    lastName: '',
    phone: '',
    companyName: '',
    position: ''
  })
  const [loading, setLoading] = useState(false)
  const [errors, setErrors] = useState<Errors>({})

  const resetForm = () => {
    setFormData({
      email: '',
      password: '',
      confirmPassword: '',
      firstName: '',
      lastName: '',
      phone: '',
      companyName: '',
      position: ''
    })
    setErrors({})
  }

  const handleClose = () => {
    resetForm()
    onClose()
  }

  const handleInputChange = (e: ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData(prev => ({ ...prev, [name]: value }))

    if (errors[name]) {
      setErrors(prev => ({ ...prev, [name]: '' }))
    }
  }

  const validateForm = () => {
    const newErrors: Errors = {}

    if (!formData.email) {
      newErrors.email = 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
    } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
      newErrors.email = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'
    }

    if (!formData.password) {
      newErrors.password = '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω'
    } else if (formData.password.length < 6) {
      newErrors.password = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤'
    }

    if (activeTab === 'register') {
      if (!formData.confirmPassword) {
        newErrors.confirmPassword = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'
      } else if (formData.password !== formData.confirmPassword) {
        newErrors.confirmPassword = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'
      }

      if (!formData.firstName) newErrors.firstName = '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'
      if (!formData.lastName) newErrors.lastName = '–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞'
      if (userType === 'hr' && !formData.companyName) {
        newErrors.companyName = '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'
      }
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault()
    if (!validateForm()) return
    setLoading(true)

    try {
      const endpoint =
        activeTab === 'login'
          ? '/api/authRoutes/login'
          : userType === 'candidate'
            ? '/api/authRoutes/register/candidate'
            : '/api/authRoutes/register/hr'

      const requestData =
        activeTab === 'login'
          ? { email: formData.email, password: formData.password }
          : userType === 'candidate'
            ? {
              email: formData.email,
              password: formData.password,
              firstName: formData.firstName,
              lastName: formData.lastName,
              phone: formData.phone
            }
            : {
              email: formData.email,
              password: formData.password,
              companyName: formData.companyName,
              firstName: formData.firstName,
              lastName: formData.lastName,
              phone: formData.phone,
              position: formData.position
            }

      const response = await fetch(`http://localhost:5000${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
      })

      const data = await response.json()
      if (response.ok) {
        localStorage.setItem('token', data.token)
        localStorage.setItem('user', JSON.stringify(data.user))
        onLogin(data.user)
        handleClose()
      } else {
        setErrors({ submit: data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞' })
      }
    } catch {
      setErrors({ submit: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º' })
    } finally {
      setLoading(false)
    }
  }

  const switchToRegister = (type: UserType) => {
    setUserType(type)
    setActiveTab('register')
    resetForm()
  }

  if (!isOpen) return null

  return (
    <AnimatePresence>
      <motion.div className={styles.popupOverlay} onClick={handleClose}>
        <div className={styles.popup} onClick={(e) => e.stopPropagation()}>
          <Button className={styles.closeButton} onClick={handleClose}>√ó</Button>
          <div className={styles.popupHeader}>
            <h2>{activeTab === 'login' ? '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}</h2>
          </div>

          {activeTab === 'login' ? (
            <LoginForm
              formData={formData}
              errors={errors}
              loading={loading}
              onInputChange={handleInputChange}
              onSubmit={handleSubmit}
              onSwitchToRegister={switchToRegister}
            />
          ) : (
            <RegisterForm
              userType={userType}
              formData={formData}
              errors={errors}
              loading={loading}
              onInputChange={handleInputChange}
              onSubmit={handleSubmit}
              onSwitchToLogin={() => {
                setActiveTab('login')
                resetForm()
              }}
              onUserTypeChange={setUserType}
            />
          )}
        </div>
      </motion.div>
    </AnimatePresence>
  )
}

const LoginForm: React.FC<LoginFormProps> = ({ formData, errors, loading, onInputChange, onSubmit, onSwitchToRegister }) => (
  <form onSubmit={onSubmit} className={styles.form}>
    <div className={styles.formGroup}>
      <label htmlFor="login-email">Email</label>
      <input
        id="login-email"
        type="email"
        name="email"
        value={formData.email}
        onChange={onInputChange}
        className={`${styles.input} ${errors.email ? styles.error : ''}`}
        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"
        autoComplete="email"
      />
      {errors.email && <span className={styles.errorText}>{errors.email}</span>}
    </div>

    <div className={styles.formGroup}>
      <label htmlFor="login-password">–ü–∞—Ä–æ–ª—å</label>
      <input
        id="login-password"
        type="password"
        name="password"
        value={formData.password}
        onChange={onInputChange}
        className={`${styles.input} ${errors.password ? styles.error : ''}`}
        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å"
        autoComplete="current-password"
      />
      {errors.password && <span className={styles.errorText}>{errors.password}</span>}
    </div>

    {errors.submit && <div className={styles.errorMessage}>{errors.submit}</div>}

    <Button type="submit" className={styles.submitButton} disabled={loading}>
      {loading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏'}
    </Button>

    <div className={styles.switch}>
      <p>–ï—â–µ –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
      <div className={styles.registerButtons}>
        <Button
          type="button"
          className={styles.optionButton}
          onClick={() => onSwitchToRegister('candidate')}
        >
          –Ø —Å–æ–∏—Å–∫–∞—Ç–µ–ª—å
        </Button>
        <Button
          type="button"
          className={styles.optionButton}
          onClick={() => onSwitchToRegister('hr')}
        >
          –Ø HR
        </Button>
      </div>
    </div>
  </form>
)

const RegisterForm: React.FC<RegisterFormProps> = ({ userType, formData, errors, loading, onInputChange, onSubmit, onSwitchToLogin, onUserTypeChange }) => (
  <form onSubmit={onSubmit} className={styles.form}>
    <div className={styles.userTypeSelector}>
      <Button
        type="button"
        // 4. –ï–©–ï –û–î–ò–ù –ü–†–ò–ú–ï–† –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –ö–õ–ê–°–°–ê
        className={`${styles.userTypeButton} ${userType === 'candidate' ? styles.active : ''}`}
        onClick={() => onUserTypeChange('candidate')}
      >
        üë§ –°–æ–∏—Å–∫–∞—Ç–µ–ª—å
      </Button>
      <Button
        type="button"
        className={`${styles.userTypeButton} ${userType === 'hr' ? styles.active : ''}`}
        onClick={() => onUserTypeChange('hr')}
      >
        üíº HR —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
      </Button>
    </div>

    <div className={styles.formRow}>
      <div className={styles.formGroup}>
        <label htmlFor="reg-firstName">–ò–º—è</label>
        <input
          id="reg-firstName"
          type="text"
          name="firstName"
          value={formData.firstName}
          onChange={onInputChange}
          className={`${styles.input} ${errors.firstName ? styles.error : ''}`}
          placeholder="–í–∞—à–µ –∏–º—è"
        />
        {errors.firstName && <span className={styles.errorText}>{errors.firstName}</span>}
      </div>

      <div className={styles.formGroup}>
        <label htmlFor="reg-lastName">–§–∞–º–∏–ª–∏—è</label>
        <input
          id="reg-lastName"
          type="text"
          name="lastName"
          value={formData.lastName}
          onChange={onInputChange}
          className={`${styles.input} ${errors.lastName ? styles.error : ''}`}
          placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è"
        />
        {errors.lastName && <span className={styles.errorText}>{errors.lastName}</span>}
      </div>
    </div>

    <div className={styles.formGroup}>
      <label htmlFor="reg-email">Email</label>
      <input
        id="reg-email"
        type="email"
        name="email"
        value={formData.email}
        onChange={onInputChange}
        className={errors.email ? styles.error : ''}
        placeholder="example@mail.com"
        autoComplete="email"
      />
      {errors.email && <span className={styles.errorText}>{errors.email}</span>}
    </div>

    {userType === 'hr' && (
      <>
        <div className={styles.formGroup}>
          <label htmlFor="reg-companyName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
          <input
            id="reg-companyName"
            type="text"
            name="companyName"
            value={formData.companyName}
            onChange={onInputChange}
            className={errors.companyName ? styles.error : ''}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"
          />
          {errors.companyName && <span className={styles.errorText}>{errors.companyName}</span>}
        </div>

        <div className={styles.formGroup}>
          <label htmlFor="reg-position">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
          <input
            id="reg-position"
            type="text"
            name="position"
            value={formData.position}
            onChange={onInputChange}
            placeholder="HR –º–µ–Ω–µ–¥–∂–µ—Ä"
          />
        </div>
      </>
    )}

    <div className={styles.formGroup}>
      <label htmlFor="reg-phone">–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input
        id="reg-phone"
        type="tel"
        name="phone"
        value={formData.phone}
        onChange={onInputChange}
        placeholder="+7 (999) 123-45-67"
      />
    </div>

    <div className={styles.formRow}>
      <div className={styles.formGroup}>
        <label htmlFor="reg-password">–ü–∞—Ä–æ–ª—å</label>
        <input
          id="reg-password"
          type="password"
          name="password"
          value={formData.password}
          onChange={onInputChange}
          className={errors.password ? styles.error : ''}
          placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"
        />
        {errors.password && <span className={styles.errorText}>{errors.password}</span>}
      </div>

      <div className={styles.formGroup}>
        <label htmlFor="reg-confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
        <input
          id="reg-confirmPassword"
          type="password"
          name="confirmPassword"
          value={formData.confirmPassword}
          onChange={onInputChange}
          className={errors.confirmPassword ? styles.error : ''}
          placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
        />
        {errors.confirmPassword && <span className={styles.errorText}>{errors.confirmPassword}</span>}
      </div>
    </div>

    {errors.submit && <div className={styles.errorMessage}>{errors.submit}</div>}

    <Button type="submit" className={styles.submitButton} disabled={loading}>
      {loading ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'}
    </Button>

    <div className={styles.switch}>
      <p>
        –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?{' '}
        <Button type="button" className={styles.switchLink} onClick={onSwitchToLogin}>
          –í–æ–π—Ç–∏
        </Button>
      </p>
    </div>
  </form>
)

export default AuthPopup
